@using System.Globalization
@model DataCo_Website.Models.Product
@{
    ViewData["Title"] = Model.ProductName;
    // Tạo culture info cho USD để hiển thị giá tiền
    var usCulture = CultureInfo.GetCultureInfo("en-US");
}

@Html.AntiForgeryToken()

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">Products</a></li>
            @if (Model.Category != null)
            {
                <li class="breadcrumb-item">
                    <a href="/department/@Model.Category.Department.Slug/category/@Model.Category.Slug">
                        @Model.Category.CategoryName
                    </a>
                </li>
            }
            <li class="breadcrumb-item active" aria-current="page">@Model.ProductName</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-5 mb-4">
            <div class="card shadow-sm border-0">
                <div class="position-relative">
                    @if (Model.Stock <= 0)
                    {
                        <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                             style="background: rgba(255,255,255,0.7); z-index: 10;">
                            <span class="badge bg-secondary fs-4 px-4 py-2">HẾT HÀNG</span>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.Image))
                    {
                        <img src="~/images/products/@Model.Image"
                             class="card-img-top p-3"
                             alt="@Model.ProductName"
                             style="max-height: 400px; object-fit: contain; background-color: #f8f9fa;">
                    }
                    else
                    {
                        <div class="card-img-top p-3 d-flex align-items-center justify-content-center"
                             style="height: 400px; background-color: #f8f9fa;">
                            <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card shadow-sm border-0">
                <div class="card-body">
                    <h2 class="card-title fw-bold mb-2">@Model.ProductName</h2>

                    <div class="d-flex align-items-center mb-3">
                        @if (Model.Category != null)
                        {
                            <span class="badge bg-light text-dark border me-2">
                                <i class="bi bi-tag"></i> @Model.Category.CategoryName
                            </span>
                        }

                        @if (Model.Stock > 0)
                        {
                            <span class="badge bg-success bg-opacity-10 text-dark border border-success">
                                <i class="bi bi-check-circle-fill"></i> Số lượng: @Model.Stock
                            </span>
                        }
                        else
                        {
                            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                                <i class="bi bi-x-circle-fill"></i> Hết hàng
                            </span>
                        }
                    </div>

                    <div class="mb-4">
                        <h3 class="text-primary fw-bold">@((Model.ProductPrice ?? 0).ToString("C", usCulture))</h3>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="mb-4">
                            <h6 class="text-muted text-uppercase fw-bold" style="font-size: 0.85rem; letter-spacing: 1px;">Mô tả sản phẩm</h6>
                            <div class="description-content">
                                @Html.Raw(Model.Description)
                            </div>
                        </div>
                    }

                    <hr class="my-4">

                    @if (User.Identity.IsAuthenticated)
                    {
                        if (Model.Stock > 0)
                        {
                            <div class="row align-items-end mb-4">
                                <div class="col-auto">
                                    <label for="quantity" class="form-label fw-bold small">Số lượng:</label>
                                    <div class="input-group input-group-sm" style="max-width: 140px;">
                                        <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <input type="number" class="form-control text-center fw-bold" id="quantity" value="1" min="1" max="@Model.Stock">
                                        <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="col">
                                    <label class="form-label fw-bold small text-muted">Tạm tính:</label>
                                    <h4 class="text-primary m-0" id="totalPrice">@((Model.ProductPrice ?? 0).ToString("C", usCulture))</h4>
                                </div>
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary btn-lg flex-grow-1" onclick="addToCartFromDetails(@Model.ProductId)">
                                    <i class="bi bi-cart-plus"></i> Thêm vào giỏ
                                </button>
                                <button class="btn btn-primary btn-lg flex-grow-1" onclick="buyNow(@Model.ProductId)">
                                    <i class="bi bi-lightning-fill"></i> Mua ngay
                                </button>
                            </div>
                        }
                        else
                        {
                            <div class="d-grid">
                                <button class="btn btn-secondary btn-lg" disabled>
                                    <i class="bi bi-emoji-frown"></i> Sản phẩm tạm thời hết hàng
                                </button>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-warning border-warning d-flex align-items-center" role="alert">
                            <i class="bi bi-exclamation-circle-fill me-2 fs-4"></i>
                            <div>
                                Vui lòng <a asp-area="Identity" asp-page="/Account/Login" class="alert-link">đăng nhập</a> để mua sản phẩm này.
                            </div>
                        </div>
                        <div class="d-grid">
                            <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-primary btn-lg">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập ngay
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="mt-5">
        <a asp-controller="Home" asp-action="Index" class="btn btn-link text-decoration-none ps-0">
            <i class="bi bi-arrow-left"></i> Quay lại trang chủ
        </a>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script>
        // Lấy giá trị từ Model C#
        const unitPrice = @(Model.ProductPrice ?? 0);
        const maxStock = @Model.Stock; // Lấy số lượng tồn kho

        function increaseQuantity() {
            const input = document.getElementById('quantity');
            let value = parseInt(input.value);
            // Kiểm tra không vượt quá tồn kho và max 99 (đề phòng số quá lớn)
            if (value < maxStock && value < 99) {
                input.value = value + 1;
                updateTotalPrice();
            } else {
                alert('Số lượng không thể vượt quá ' + maxStock);
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity');
            let value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
                updateTotalPrice();
            }
        }

        function updateTotalPrice() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const total = unitPrice * quantity;
            document.getElementById('totalPrice').textContent = total.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD'
            });
        }

        // Sự kiện nhập tay vào ô input
        const qtyInput = document.getElementById('quantity');
        if(qtyInput){
            qtyInput.addEventListener('change', function() {
                let value = parseInt(this.value);

                if (isNaN(value) || value < 1) {
                    this.value = 1;
                }
                else if (value > maxStock) {
                    alert('Chỉ còn lại ' + maxStock + ' sản phẩm trong kho.');
                    this.value = maxStock;
                }
                updateTotalPrice();
            });
        }

        window.addToCartFromDetails = function(productId) {
            const quantity = parseInt(document.getElementById('quantity').value);

            // Logic AddToCart gốc của bạn (giả sử hàm addToCart global đã có sẵn)
            if(typeof addToCart === "function") {
                 addToCart(productId, quantity);
            } else {
                 // Fallback nếu không có hàm global, dùng ajax tại chỗ (giống buyNow nhưng không redirect)
                 buyNow(productId, false);
            }

            // Reset về 1 sau khi thêm (tùy chọn)
            setTimeout(function() {
                // document.getElementById('quantity').value = 1; 
                // updateTotalPrice();
            }, 500);
        }

        function buyNow(productId, redirect = true) {
            const quantity = parseInt(document.getElementById('quantity').value);
            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: {
                    productId: productId,
                    quantity: quantity,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    if (response.success) {
                        if(redirect) {
                            window.location.href = '@Url.Action("Checkout", "Cart")';
                        } else {
                             // Hiển thị thông báo toast/alert thành công nếu chỉ add to cart
                             alert("Đã thêm vào giỏ hàng!");
                        }
                    } else {
                        alert(response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi kết nối server');
                }
            });
        }
    </script>

    <style>
        .description-content {
            line-height: 1.6;
            color: #555;
        }

            .description-content img {
                max-width: 100%;
                height: auto;
            }
        /* Ẩn nút tăng giảm mặc định của trình duyệt cho input number */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
}