@model DataCo_Website.Models.Product
@{
    ViewData["Title"] = Model.ProductName;
}

@Html.AntiForgeryToken()

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">Products</a></li>
            @if (Model.Category != null)
            {                
                <li class="breadcrumb-item">
                    <a href="/department/@Model.Category.Department.Slug/category/@Model.Category.Slug">
                        @Model.Category.CategoryName                        
                    </a>                    
                </li>
            }
            <li class="breadcrumb-item active" aria-current="page">@Model.ProductName</li>
        </ol>
    </nav>

    <div class="row">
        <!-- Hình ảnh sản phẩm -->
        <div class="col-md-5">
            <div class="card shadow-sm">
                @if (!string.IsNullOrEmpty(Model.Image))
                {
                    <img src="~/images/products/@Model.Image"
                         class="card-img-top p-3"
                         alt="@Model.ProductName"
                         style="max-height: 400px; object-fit: contain; background-color: #f8f9fa;">
                }
                else
                {
                    <div class="card-img-top p-3 d-flex align-items-center justify-content-center"
                         style="height: 400px; background-color: #f8f9fa;">
                        <i class="bi bi-image text-muted" style="font-size: 5rem;"></i>
                    </div>
                }
            </div>
        </div>

        <!-- Thông tin sản phẩm -->
        <div class="col-md-7">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h2 class="card-title mb-3">@Model.ProductName</h2>

                    @if (Model.Category != null)
                    {
                        <p class="text-muted mb-3">
                            <i class="bi bi-tag"></i> Category:
                            <a asp-action="Index" asp-route-categoryId="@Model.CategoryId" class="text-decoration-none">
                                @Model.Category.CategoryName
                            </a>
                        </p>
                    }

                    <div class="mb-4">
                        <h3 class="text-primary fw-bold">@String.Format("{0:C}", Model.ProductPrice)</h3>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Description))
                    {
                        <div class="mb-4">
                            <h5><i class="bi bi-info-circle"></i> Mô tả sản phẩm</h5>
                            <div class="p-3 bg-light rounded description-content">
                                @Html.Raw(Model.Description)
                            </div>
                        </div>
                    }

                    <hr>

                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="row align-items-center mb-3">
                            <div class="col-md-4">
                                <label for="quantity" class="form-label">Số lượng:</label>
                                <div class="input-group">
                                    <button class="btn btn-outline-secondary" type="button" onclick="decreaseQuantity()">
                                        <i class="bi bi-dash"></i>
                                    </button>
                                    <input type="number" class="form-control text-center" id="quantity" value="1" min="1" max="99">
                                    <button class="btn btn-outline-secondary" type="button" onclick="increaseQuantity()">
                                        <i class="bi bi-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Tổng giá:</label>
                                <h5 class="text-primary" id="totalPrice">@String.Format("{0:C}", Model.ProductPrice)</h5>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" onclick="addToCartFromDetails(@Model.ProductId)">
                                <i class="bi bi-cart-plus"></i> Thêm vào giỏ hàng
                            </button>
                            <button class="btn btn-primary btn-lg" onclick="buyNow(@Model.ProductId)">
                                <i class="bi bi-lightning-fill"></i> Mua ngay
                            </button>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info" role="alert">
                            <i class="bi bi-info-circle"></i> Vui lòng
                            <a asp-area="Identity" asp-page="/Account/Login" class="alert-link">đăng nhập</a>
                            để mua sản phẩm này.
                        </div>
                        <div class="d-grid">
                            <a asp-area="Identity" asp-page="/Account/Login" class="btn btn-primary btn-lg">
                                <i class="bi bi-box-arrow-in-right"></i> Đăng nhập
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Nút quay lại -->
    <div class="mt-4">
        <a asp-controller="Home" asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại trang chủ
        </a>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script>
        const unitPrice = @Model.ProductPrice;

        function increaseQuantity() {
            const input = document.getElementById('quantity');
            let value = parseInt(input.value);
            if (value < 99) {
                input.value = value + 1;
                updateTotalPrice();
            }
        }

        function decreaseQuantity() {
            const input = document.getElementById('quantity');
            let value = parseInt(input.value);
            if (value > 1) {
                input.value = value - 1;
                updateTotalPrice();
            }
        }

        function updateTotalPrice() {
            const quantity = parseInt(document.getElementById('quantity').value);
            const total = unitPrice * quantity;
            document.getElementById('totalPrice').textContent = total.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD'
            });
        }

        document.getElementById('quantity').addEventListener('input', function() {
            let value = parseInt(this.value);
            if (isNaN(value) || value < 1) {
                this.value = 1;
            } else if (value > 99) {
                this.value = 99;
            }
            updateTotalPrice();
        });

        window.addToCartFromDetails = function(productId) {
            const quantity = parseInt(document.getElementById('quantity').value);
            addToCart(productId, quantity);

            setTimeout(function() {
                document.getElementById('quantity').value = 1;
                updateTotalPrice();
            }, 500);
        }

        function buyNow(productId) {
            const quantity = parseInt(document.getElementById('quantity').value);
            var token = $('input[name="__RequestVerificationToken"]').val();

            $.ajax({
                url: '@Url.Action("AddToCart", "Cart")',
                type: 'POST',
                data: {
                    productId: productId,
                    quantity: quantity,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    if (response.success) {
                        window.location.href = '@Url.Action("Checkout", "Cart")';
                    } else {
                        alert(response.message || 'Có lỗi xảy ra');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra');
                }
            });
        }
    </script>

    <style>
        .description-content {
            line-height: 1.8;
        }

            .description-content h1 {
                font-size: 1.75rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .description-content h2 {
                font-size: 1.5rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .description-content h3 {
                font-size: 1.25rem;
                margin-top: 1rem;
                margin-bottom: 0.5rem;
                font-weight: 600;
            }

            .description-content ul,
            .description-content ol {
                margin-left: 1.5rem;
                margin-bottom: 1rem;
            }

            .description-content p {
                margin-bottom: 0.75rem;
            }

            .description-content a {
                color: #0d6efd;
                text-decoration: underline;
            }

            .description-content strong {
                font-weight: 600;
            }
    </style>
}