@using System.Globalization
@model IEnumerable<DataCo_Website.Models.Product>

@{
    ViewData["Title"] = "Products";
    var categoryName = ViewBag.CategoryName as string;
    int page = ViewBag.Page;
    int totalPages = ViewBag.TotalPages;
    int? categoryId = ViewBag.CategoryId as int?;
    string searchQuery = ViewBag.SearchQuery as string;

    // Tạo định dạng văn hóa Mỹ (USD)
    var usCulture = CultureInfo.GetCultureInfo("en-US");
}

@Html.AntiForgeryToken()

<div class="search-box" id="search-box">
    <div class="container-md d-flex justify-content-center align-items-center h-100 position-relative">
        <div class="search-wrap">
            <form asp-action="Index" method="get" class="position-relative">
                <input type="text"
                       name="searchQuery"
                       class="search-input form-control"
                       placeholder="Search for products..."
                       value="@searchQuery"
                       autocomplete="off">
                <input type="hidden" name="categoryId" value="@categoryId" />
                <button type="submit" class="btn btn-link position-absolute" style="right: 15px; top: 50%; transform: translateY(-50%); z-index: 10;">
                    <svg class="search" width="22" height="22">
                        <use xlink:href="#search"></use>
                    </svg>
                </button>
            </form>
        </div>
    </div>
</div>

<section id="featured-products" class="product-store">
    <div class="container-md">
        <div class="display-header d-flex align-items-center justify-content-between mb-4">
            <h2 class="section-title text-uppercase m-0">
                @if (!string.IsNullOrEmpty(categoryName))
                {
                    <text>@categoryName</text>
                }
                else if (!string.IsNullOrEmpty(searchQuery))
                {
                    <text>Search Results for "@searchQuery"</text>
                }
                else
                {
                    <text>All Products</text>
                }
            </h2>
            <div class="btn-right d-flex gap-2">
                <button type="button" class="btn btn-outline-dark btn-sm" onclick="toggleSearch()" title="Search">
                    <svg width="18" height="18" fill="currentColor">
                        <use xlink:href="#search"></use>
                    </svg>
                </button>

                @if (!string.IsNullOrEmpty(categoryName))
                {
                    <a asp-controller="Categories" asp-action="Index" class="btn btn-outline-dark btn-sm">
                        ← Back to Categories
                    </a>
                }

                @if (!string.IsNullOrEmpty(searchQuery))
                {
                    <a asp-action="Index" asp-route-categoryId="@categoryId" class="btn btn-outline-dark btn-sm">
                        ✕ Clear Search
                    </a>
                }
            </div>
        </div>

        @if (Model.Any())
        {
            <div class="product-content padding-small">
                <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-5">
                    @foreach (var item in Model)
                    {
                        <div class="col mb-4">
                            <div class="product-card position-relative">
                                <div class="card-img">
                                    <a href="@item.FullUrl">
                                        @if (!string.IsNullOrEmpty(item.Image))
                                        {
                                            <img src="~/images/products/@item.Image" alt="@item.ProductName" class="product-image img-fluid">
                                        }
                                        else
                                        {
                                            <img src="~/images/placeholder.jpg" alt="No image" class="product-image img-fluid">
                                        }
                                    </a>

                                    <div class="cart-concern position-absolute d-flex justify-content-center">
                                        <div class="cart-button d-flex gap-2 justify-content-center align-items-center">
                                            @if (User.Identity.IsAuthenticated)
                                            {
                                                @if (item.Stock > 0)
                                                {
                                                    <button type="button" class="btn btn-add-to-cart" onclick="addToCart(@item.ProductId)" title="Add to Cart">
                                                        <svg class="shopping-carriage" width="20" height="20">
                                                            <use xlink:href="#shopping-carriage"></use>
                                                        </svg>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <button type="button" class="btn btn-secondary" disabled title="Out of Stock">
                                                        <i class="bi bi-x-circle"></i>
                                                    </button>
                                                }
                                            }
                                            <a href="@item.FullUrl" class="btn quick-view" title="Quick View">
                                                <svg class="quick-view" width="20" height="20">
                                                    <use xlink:href="#quick-view"></use>
                                                </svg>
                                            </a>
                                        </div>
                                    </div>

                                    @if (item.Stock <= 0)
                                    {
                                        <div class="position-absolute top-0 start-0 m-2 badge bg-secondary">Out of Stock</div>
                                    }
                                </div>

                                <div class="card-detail d-flex justify-content-between align-items-center mt-3">
                                    <h3 class="card-title fs-6 fw-normal m-0">
                                        <a href="@item.FullUrl" class="text-decoration-none text-dark">
                                            @item.ProductName
                                        </a>
                                    </h3>
                                    <span class="card-price fw-bold text-primary">
                                        @((item.ProductPrice ?? 0).ToString("C", usCulture))
                                    </span>
                                </div>

                                @if (!string.IsNullOrEmpty(item.Category?.CategoryName))
                                {
                                    <div class="mt-2">
                                        <span class="badge bg-light text-dark border">@item.Category.CategoryName</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
        else
        {
            <div class="text-center py-5">
                <p class="text-muted fs-5">
                    @if (!string.IsNullOrEmpty(searchQuery))
                    {
                        <text>No products found for "@searchQuery".</text>
                    }
                    else
                    {
                        <text>No products found.</text>
                    }
                </p>
            </div>
        }

        @if (totalPages > 1)
        {
            <nav aria-label="Page navigation" class="mt-5">
                <ul class="pagination justify-content-center">
                    <li class="page-item @(page == 1 ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(page - 1)" asp-route-categoryId="@categoryId" asp-route-searchQuery="@searchQuery">
                            Previous
                        </a>
                    </li>

                    @{
                        int start = Math.Max(1, page - 2);
                        int end = Math.Min(totalPages, page + 2);

                        if (start > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" asp-action="Index" asp-route-page="1" asp-route-categoryId="@categoryId" asp-route-searchQuery="@searchQuery">1</a>
                            </li>
                            if (start > 2)
                            {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                        }

                        for (int i = start; i <= end; i++)
                        {
                            <li class="page-item @(i == page ? "active" : "")">
                                <a class="page-link" asp-action="Index" asp-route-page="@i" asp-route-categoryId="@categoryId" asp-route-searchQuery="@searchQuery">@i</a>
                            </li>
                        }

                        if (end < totalPages)
                        {
                            if (end < totalPages - 1)
                            {
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                            <li class="page-item">
                                <a class="page-link" asp-action="Index" asp-route-page="@totalPages" asp-route-categoryId="@categoryId" asp-route-searchQuery="@searchQuery">@totalPages</a>
                            </li>
                        }
                    }

                    <li class="page-item @(page == totalPages ? "disabled" : "")">
                        <a class="page-link" asp-action="Index" asp-route-page="@(page + 1)" asp-route-categoryId="@categoryId" asp-route-searchQuery="@searchQuery">
                            Next
                        </a>
                    </li>
                </ul>
            </nav>
        }
    </div>
</section>

@section Scripts {
    <script>
        function toggleSearch() {
            var searchBox = document.getElementById('search-box');
            searchBox.classList.toggle('active');

            if (searchBox.classList.contains('active')) {
                // Focus vào input khi mở
                setTimeout(function() {
                    searchBox.querySelector('.search-input').focus();
                }, 300);
            }
        }

        // Đóng search box khi nhấn ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                var searchBox = document.getElementById('search-box');
                if (searchBox.classList.contains('active')) {
                    searchBox.classList.remove('active');
                }
            }
        });
    </script>
}